<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-new-view">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 16px;
      }

      * {
      	margin: 0;
      	padding: 0;
      	-webkit-box-sizing: border-box;
      	-moz-box-sizing: border-box;
      	box-sizing: border-box;
      }

      body {
      	background: #FAFAFA;
      	font-family: arial, helvetica, sans-serif;
      	font-size: 16px;
      }

      .wrap {
      	margin: auto;
      	max-width: 800px;
      	width: 90%;
      }

      .principal {
      	background: #F44336;
      	border-top: 20px solid #D32F2F;
      	color: #fff;
      	padding: 50px 0;
      	width: 100%;
      }

      .principal .formulario {
      	color: #212121;
      	text-align: center;
      }

      .principal .formulario input[type=text] {
      	margin-bottom: 20px;
      	padding: 10px;
      	width: 100%;
      }

      .principal .formulario input[type=text].error {
      	border: 5px solid #D32F2F;
      	color: red;
      }

      .principal .formulario .boton {
      	background: none;
      	border: 1px solid #D32F2F;
      	color: #fff;
      	display: inline-block;
      	font-size: 16px;
      	padding: 15px;
      }

      .principal .formulario .boton:hover {
      	border: 1px solid #fff;
      }

      /* - Tareas - */
      .tareas .lista {
      	list-style: none;
      }

      .tareas .lista li {
      	border-bottom: 1px solid #B6B6B6;
      }

      .tareas .lista li a {
      	color: #212121;
      	display: block;
      	padding: 20px 0;
      	text-decoration: none;
      }

      .tareas .lista li a:hover {
      	text-decoration: line-through;
      }

      /* Prevent the text contents of draggable elements from being selectable. */
      [draggable] {
        -moz-user-select: none;
        -khtml-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        /* Required to make elements draggable in old WebKit */
        -khtml-user-drag: element;
        -webkit-user-drag: element;
      }

    </style>

    <!--<h1>New view</h1>-->

  	<div class="principal">
  		<div class="wrap">
  			<form class="formulario" action="">
  				<input id="tareaInput" placeholder="Agrega tu tarea" class="" type="text">
  				<input class="boton" id="btn-agregar" value="Agregar Tarea" type="button">
  			</form>
  		</div>
  	</div>

  	<div class="tareas">
  		<div class="wrap">
  			<ul class="lista" id="lista">
  			</ul>
  		</div>
  	</div>
  	<!--<script src="main.js"></script>-->



  </template>
  <!-- Creates the element's prototype and registers it -->
  <script>
    Polymer({
      is: 'my-new-view',

      properties: {

      },

      created: function() {
        console.log(this.localName + '#' + this.id + ' was created');
      },

      ready: function() {

      	// Variables
      	var lista = document.getElementById("lista"),
      		tareaInput = document.getElementById("tareaInput"),
      		btnNuevaTarea = document.getElementById("btn-agregar");

      	// Funciones
      	var agregarTarea = function(){
      		var tarea = tareaInput.value,
      			nuevaTarea = document.createElement("li"),
      			enlace = document.createElement("a"),
      			contenido = document.createTextNode(tarea);

      		if (tarea === "") {
      			tareaInput.setAttribute("placeholder", "Agrega una tarea valida");
      			tareaInput.className = "error";
      			return false;
      		}

      		// Agregamos el contenido al enlace
      		enlace.appendChild(contenido);
      		// Le establecemos un atributo href
      		enlace.setAttribute("href", "#");
          enlace.setAttribute("class", "style-scope my-new-view");
      		// Agrergamos el enlace (a) a la nueva tarea (li)
      		nuevaTarea.appendChild(enlace);
          nuevaTarea.setAttribute("class", "style-scope my-new-view");
          nuevaTarea.setAttribute("draggable", "true");
      		// Agregamos la nueva tarea a la lista
      		lista.appendChild(nuevaTarea);

      		tareaInput.value = "";

      		for (var i = 0; i <= lista.children.length -1; i++) {
      			lista.children[i].addEventListener("click", function(){
      				this.parentNode.removeChild(this);
      			});
      		}

      	};
      	var comprobarInput = function(){
      		tareaInput.className = "";
      		teareaInput.setAttribute("placeholder", "Agrega tu tarea");
      	};

      	var eleminarTarea = function(){
      		this.parentNode.removeChild(this);
      	};

      	// Eventos

      	// Agregar Tarea
      	btnNuevaTarea.addEventListener("click", agregarTarea);

      	// Comprobar Input
      	tareaInput.addEventListener("click", comprobarInput);

      	// Borrando Elementos de la lista
      	for (var i = 0; i <= lista.children.length -1; i++) {
      		lista.children[i].addEventListener("click", eleminarTarea);
      	}

        // the WAMP connection to the Router
        //
        alert('okokokokokokko');
        var connection = new autobahn.Connection({
           // url: wsuri,


           transports: [
              {
                 'type': 'websocket',
                 'url': wsuri
              },
              {
                 'type': 'longpoll',
                 'url': httpUri
              }
           ],
           realm: "realm1"
        });


        // fired when connection is established and session attached
        //
        connection.onopen = function (session, details) {

           main(session);

        };

        function main (session) {

          console.log ("OK");

           // subscribe to future vote event
           /*session.subscribe("io.crossbar.demo.vote.onvote",
              function(args) {
                 var event = args[0];
                 document.getElementById("votes" + event.subject).value =
                    event.votes;
              });*/

            // subscribe to future vote event
            session.subscribe("io.crossbar.app.onupdateList",
               function(args) {
                  var event = args[0];
                  document.getElementById("lista").innerHTML = event;
                     //event.votes;
               });


          // get the current vote count
          /*session.call("io.crossbar.demo.vote.get").then(
             function(res){
                for(var i = 0; i < res.length; i++) {
                   document.getElementById("votes" + res[i].subject).value =
                      res[i].votes;
                }
          }, session.log);*/

           //"""MY APP"""// get the current vote count
           session.call("io.crossbar.app.get").then(
              function(res){
                document.getElementById("lista").innerHTML = res['action'];
              }, session.log);

           // wire up vote buttons
           /*var voteButtons = document.getElementById("voteContainer").
                                      getElementsByTagName("button");
           for (var i = 0; i < voteButtons.length; i++) {
              voteButtons[i].addEventListener("click", function(evt) {
                 session.call("io.crossbar.demo.vote.vote",
                    [evt.target.id]).then(session.log, session.log);
              });
           }*/

            //""" MY APP"""
           var addList = document.getElementById("btn-agregar");
           addList.addEventListener("click", function(evt) {
             session.call("io.crossbar.app.updatelista",
                [evt.target]).then(session.log, session.log);
           });

           // subscribe to vote reset event
           /*session.subscribe("io.crossbar.demo.vote.onreset", function() {
                 var voteCounters = document.getElementById("voteContainer").
                                             getElementsByTagName("input");
                 for(var i = 0; i < voteCounters.length; i++) {
                    voteCounters[i].value = 0;
                 }
              });*/

           // wire up reset button
           /*document.getElementById("resetVotes").onclick = function() {
              session.call("io.crossbar.demo.vote.reset").
                 then(session.log, session.log);
           };*/

         }


        // fired when connection was lost (or could not be established)
        //
        connection.onclose = function (reason, details) {

           console.log("Connection lost: " + reason);

        }


        // now actually open the connection
        //
        connection.open();

        console.log(this.localName + '#' + this.id + ' has local DOM initialized');
      },

      //Cuando el componente esta adjuntado al html
      attached: function() {
        console.log(this.localName + '#' + this.id + ' was attached');
      },

      detached: function() {
        console.log(this.localName + '#' + this.id + ' was detached');
      },

      attributeChanged: function(name, type) {
        console.log(this.localName + '#' + this.id + ' attribute ' + name +
          ' was changed to ' + this.getAttribute(name));
      }
    });
  </script>
</dom-module>
